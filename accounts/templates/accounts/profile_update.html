{% extends "base.html" %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'accounts/css/profile_update.css' %}">

<div class="form-container">
    <form id="update-profile-form">
        <label for="image" class="image-label">
            <input type="file" id="image" name="image">
            <img id="image-preview" alt="Preview Image">
        </label><br>

        <label for="username">이름</label>
        <input type="text" id="username" name="username" autocomplete="username" required placeholder="새 아이디"><br>
        
        <label for="nickname">닉네임</label>
        <input type="text" id="nickname" name="nickname" autocomplete="nickname" required placeholder="새 닉네임"><br>
        
        <label for="email">이메일</label>
        <input type="email" id="email" name="email" autocomplete="email" required placeholder="사용 중인 이메일"><br>
        
        <button type="submit">프로필 수정</button>
    </form>

    <form id="change-password-form">
        <label for="current_password">현재 비밀번호</label>
        <input type="password" id="current_password" name="current_password" required><br>
        
        <label for="new_password">새 비밀번호</label>
        <input type="password" id="new_password" name="new_password" required><br>
        
        <button type="submit">비밀번호 변경</button>
    </form>


    <script>
        document.getElementById('image').addEventListener('change', function(event) {
            const input = event.target;
            const reader = new FileReader();
            
            reader.onload = function() {
                const preview = document.getElementById('image-preview');
                preview.src = reader.result; // 파일의 내용을 미리보기 이미지로 설정
                preview.style.display = 'block'; // 미리보기 이미지를 보이도록 설정
            }
            
            reader.readAsDataURL(input.files[0]); // 파일을 읽어오기
        });

        document.getElementById('update-profile-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const userId = "{{ user_id }}"; // Django 템플릿에서 제공한 user_id
            const csrfToken = "{{ csrf_token }}"; // Django 템플릿에서 제공한 CSRF 토큰
            const accessToken = localStorage.getItem('access'); // 로컬 스토리지에서 Access Token 가져오기

            const formData = new FormData();
            formData.append('username', document.getElementById('username').value);
            formData.append('nickname', document.getElementById('nickname').value);
            formData.append('email', document.getElementById('email').value);
            const imageFile = document.getElementById('image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            axios.put(`/api/accounts/api/profile/${userId}/update/`, formData, {
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'multipart/form-data',
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(function(response) {
                alert('프로필 변경에 성공하셨습니다!');
                window.location.href = `/api/accounts/profile/${userId}/`
                console.log(response.data);
            })
            .catch(function(error) {
                console.error('There was an error!', error);
                if (error.response) {
                    alert('Failed to update profile: ' + (error.response.data.error || error.response.data));
                } else {
                    alert('Failed to update profile.');
                }
            });
        });

        document.getElementById('change-password-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const userId = "{{ user_id }}"; // Django 템플릿에서 제공한 user_id
            const csrfToken = "{{ csrf_token }}"; // Django 템플릿에서 제공한 CSRF 토큰
            const accessToken = localStorage.getItem('access'); // 로컬 스토리지에서 Access Token 가져오기

            const data = {
                current_password: document.getElementById('current_password').value,
                new_password: document.getElementById('new_password').value
            };

            axios.put(`/api/accounts/api/profile/${userId}/change-password/`, data, {
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(function(response) {
                alert('비밀번호 변경을 성공하셨습니다!');
                window.location.href = '{% url "test" %}'
                console.log(response.data);
            })
            .catch(function(error) {
                console.error('There was an error!', error);
                if (error.response) {
                    alert('비밀번호를 변경할 수 없습니다: ' + (error.response.data.error || error.response.data));
                } else {
                    alert('변경 불가');
                }
            });
        });

        document.getElementById('delete-account-button').addEventListener('click', function() {
            const userId = "{{ user_id }}"; // Django 템플릿에서 제공한 user_id
            const csrfToken = "{{ csrf_token }}"; // Django 템플릿에서 제공한 CSRF 토큰
            const accessToken = localStorage.getItem('access_token'); // 로컬 스토리지에서 Access Token 가져오기
        
            if (confirm('정말로 계정을 삭제하시겠나요? 다시 되돌릴 수 없습니다.')) {
                axios.delete(`/api/accounts/api/profile/${userId}/delete/`, { // URL 수정
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Authorization': `Bearer ${accessToken}`
                    }
                })
                .then(function(response) {
                    alert('탈출 성공하셨습니다!');
                    console.log(response.data);
                    // 로그아웃 또는 페이지 리디렉션 처리
                })
                .catch(function(error) {
                    console.error('There was an error!', error);
                    if (error.response) {
                        alert('탈퇴 실패: ' + (error.response.data.error || error.response.data));
                    } else {
                        alert('계정 탈출 실패');
                    }
                });
            }
        });
        
    </script>
</div>
{% endblock content %}
