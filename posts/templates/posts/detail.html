{% extends "base.html" %}

{% block content %}
<h1 id="post-title"></h1>
<p id="post-content"></p>
<p id="post-author"></p>
<p id="post-likes"></p>
<p id="post-created"></p>
<p id="post-updated"></p>

<h2>댓글</h2>
<ul id="comments-list"></ul>

<h2>댓글 추가</h2>
<form id="comment-form">
    <textarea id="comment-content" rows="4" cols="50" placeholder="여기에 댓글을 작성하세요..."></textarea><br>
    <input type="submit" value="댓글 작성">
</form>

<script>
    const postId = /* post_id를 동적으로 설정 */;

    document.addEventListener('DOMContentLoaded', async function() {
        try {
            // 게시물 데이터를 불러오기
            const response = await axios.get(`/api/posts/${postId}/`);
            const post = response.data;
            
            document.getElementById('post-title').innerText = post.title;
            document.getElementById('post-content').innerText = post.content;
            document.getElementById('post-author').innerText = `작성자: ${post.user}`;
            document.getElementById('post-likes').innerText = `좋아요: ${post.like}`;
            document.getElementById('post-created').innerText = `작성일: ${post.created_at}`;
            document.getElementById('post-updated').innerText = `수정일: ${post.updated_at}`;

            const commentsList = document.getElementById('comments-list');
            post.comments.forEach(comment => {
                const commentItem = document.createElement('li');
                commentItem.innerHTML = `
                    <p>${comment.content}</p>
                    <p>작성자: ${comment.user} | 작성일: ${comment.created_at} | 수정일: ${comment.updated_at}</p>
                    <button onclick="editComment(${comment.id})">수정</button>
                    <button onclick="deleteComment(${comment.id})">삭제</button>
                `;
                commentsList.appendChild(commentItem);
            });
        } catch (error) {
            console.error('게시물 데이터를 가져오는 중 오류 발생:', error);
        }

        // 댓글 작성 폼 제출 처리
        document.getElementById('comment-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const content = document.getElementById('comment-content').value;

            try {
                await axios.post(`/api/posts/${postId}/comments/`, { content }, {
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                alert('댓글이 작성되었습니다.');
                location.reload(); // 페이지 새로고침하여 댓글 목록 업데이트
            } catch (error) {
                console.error('댓글 작성 중 오류 발생:', error);
            }
        });
    });

    async function editComment(commentId) {
        // 댓글 수정 로직을 추가하세요
        // 예: 수정할 내용을 입력받는 폼을 표시하고, axios.put을 사용하여 서버에 요청
    }

    async function deleteComment(commentId) {
        if (confirm('이 댓글을 삭제하시겠습니까?')) {
            try {
                await axios.delete(`/api/comments/${commentId}/`, {
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                alert('댓글이 삭제되었습니다.');
                location.reload(); // 페이지 새로고침하여 댓글 목록 업데이트
            } catch (error) {
                console.error('댓글 삭제 중 오류 발생:', error);
            }
        }
    }
</script>
{% endblock content %}